<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Din KÃ¼ltÃ¼rÃ¼ â€” Modlu Ã‡alÄ±ÅŸma & SÄ±nav (Fix)</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg: linear-gradient(135deg,#667eea,#764ba2);
  --card: rgba(255,255,255,.18);
  --text: #fff;
  --muted: rgba(255,255,255,.8);
  --btn: rgba(255,255,255,.26);
  --active: rgba(255,255,255,.38);
  --accent: #ffd166;
  --dim: rgba(0,0,0,0.28);
  --danger: rgba(255,90,90,0.95);
}
body.light{
  --bg: linear-gradient(135deg,#e0eafc,#cfdef3);
  --card: rgba(255,255,255,.95);
  --text:#222;
  --muted:#444;
  --btn: rgba(0,0,0,.08);
  --active: rgba(0,0,0,.12);
  --dim: rgba(255,255,255,0.18);
}
*{box-sizing:border-box;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
html,body{height:100%;margin:0}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  color:var(--text);
  padding:20px;
}

/* Container: limit height so content doesn't push pop-up off-screen */
.container{
  width:100%;
  max-width:980px;
  background:var(--card);
  border-radius:18px;
  padding:0; /* settings is sticky inside */
  box-shadow:0 30px 60px rgba(0,0,0,.25);
  backdrop-filter: blur(12px);
  position:relative;
  max-height:calc(100vh - 40px);
  overflow:auto; /* scroll inside container when content grows */
  display:flex;
  flex-direction:column;
}

/* dim overlay used in focus mode */
.dim-overlay{
  pointer-events:none;
  position:absolute;
  inset:0;
  background:transparent;
  transition:background .25s ease;
  border-radius:18px;
  z-index:5;
}

/* SETTINGS - sticky so it doesn't move when content grows */
.settings{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  padding:14px;
  background:var(--card);
  position:sticky;
  top:0;
  z-index:20;
  border-top-left-radius:18px;
  border-top-right-radius:18px;
  backdrop-filter: blur(8px);
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}
.settings button, .small-btn{
  background:var(--btn);
  color:var(--text);
  border:0;
  padding:9px 12px;
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
}
.mode-btn.active{
  background:var(--active);
  box-shadow:inset 0 4px 10px rgba(0,0,0,.08);
  border:1px solid rgba(0,0,0,.04);
}

/* questions list area: scrollable if content large */
.content{
  padding:16px;
  overflow:auto;
}

/* Study questions */
.questions{margin-top:6px}
.question{
  background: rgba(255,255,255,.10);
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease, opacity .18s ease, border-color .12s ease;
  position:relative;
  z-index:1;
  border:2px solid transparent;
}
.question:hover{transform:translateY(-4px); box-shadow:0 10px 30px rgba(0,0,0,.08)}
.question.blur{filter:blur(4px); opacity:.75}
.question h4{margin:0 0 8px;font-size:16px}
.answer{max-height:0;overflow:hidden;opacity:0;transition:all .35s ease}
.answer.open{max-height:600px;opacity:1}
.q-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}

/* reveal button progress bar */
.reveal-btn{
  position:relative;
  overflow:hidden;
}
.reveal-progress{
  position:absolute;
  left:0; top:0; bottom:0;
  height:100%;
  width:0%;
  background:linear-gradient(90deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
  transition:width .1s linear;
  z-index:0;
}
.reveal-btn > * { position:relative; z-index:1; }

/* self-eval after revealing (game) */
.self-eval{
  margin-top:8px;
  display:flex;
  gap:8px;
  align-items:center;
}
.eval-btn{
  padding:8px 10px;
  border-radius:10px;
  border:0;
  background:var(--btn);
  color:var(--text);
  cursor:pointer;
}

/* wrong flash animation */
@keyframes wrongFlash {
  0% { box-shadow: 0 0 0 0 rgba(255,90,90,0.0); border-color: rgba(255,90,90,0.0); }
  20% { box-shadow: 0 0 0 6px rgba(255,90,90,0.12); border-color: var(--danger); }
  100% { box-shadow: 0 0 0 0 rgba(255,90,90,0.0); border-color: transparent; }
}
.question.wrong{
  animation: wrongFlash .9s ease forwards;
  border-color: var(--danger);
}

/* toast for badges / messages */
.toast{
  position:fixed;
  right:20px;
  bottom:20px;
  background:rgba(0,0,0,.85);
  color:#fff;
  padding:10px 14px;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.3);
  opacity:0;
  transform:translateY(8px);
  transition:all .35s ease;
  z-index:9999;
  display:flex;
  gap:10px;
  align-items:center;
}
.toast.show{opacity:1; transform:translateY(0)}
.toast .badge{
  background:var(--accent);
  padding:6px 8px;
  border-radius:8px;
  color:#000;
  font-weight:700;
}

/* Exam UI */
.screen{display:none}
.screen.active{display:block}

.exam-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.timer{font-weight:600}
.progress{opacity:.9}

.mcq-card{
  background: rgba(255,255,255,.06);
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
}
.options{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.option{
  border-radius:10px;
  padding:10px 12px;
  background:rgba(255,255,255,.08);
  cursor:pointer;
  border:2px solid transparent;
}
.option.selected{outline:0;border-color: rgba(255,255,255,.22)}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.big-btn{
  flex:1;
  padding:12px 14px;
  border-radius:12px;
  border:0;
  background:var(--btn);
  color:var(--text);
  cursor:pointer;
}
.result-list{margin-top:12px}
.result-item{
  background:rgba(255,255,255,.06);
  border-radius:10px;
  padding:10px;
  margin-bottom:8px;
}

/* status bar */
.statusbar{
  margin-top:8px;
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:center;
  font-size:14px;
  opacity:.95;
  padding:12px 16px;
  border-top:1px solid rgba(0,0,0,.04);
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border-bottom-left-radius:18px;
  border-bottom-right-radius:18px;
}
.status-left{display:flex;gap:10px;align-items:center}
.score-badge{
  background:var(--accent);
  color:#000;
  padding:6px 10px;
  border-radius:12px;
  font-weight:600;
}

/* Responsive */
@media (max-width:720px){
  .settings{gap:6px}
  .statusbar{font-size:13px}
}
</style>
</head>
<body>

<div class="container" id="appContainer">
  <div class="dim-overlay" id="dimOverlay"></div>

  <div class="settings" id="topSettings">
    <button class="small-btn" onclick="toggleTheme()">ğŸŒ™ / â˜€ï¸</button>

    <button class="small-btn mode-btn" data-mode="think" onclick="toggleMode('think', this)">ğŸ§  DÃ¼ÅŸÃ¼n (5s)</button>
    <button class="small-btn mode-btn" data-mode="game" onclick="toggleMode('game', this)">ğŸ® Oyun</button>
    <button class="small-btn mode-btn" data-mode="focus" onclick="toggleMode('focus', this)">ğŸ‘ï¸ Odak</button>

    <button class="small-btn" onclick="openExamSetup()">ğŸ“ SÄ±nav Modu (Kurulum)</button>
    <button class="small-btn" onclick="openAll()">ğŸ“‚ TÃ¼mÃ¼nÃ¼ AÃ§</button>
    <button class="small-btn" onclick="closeAll()">ğŸ“ TÃ¼mÃ¼nÃ¼ Kapat</button>
    <button class="small-btn" onclick="toggleStarOnly()">â­ Sadece Ä°ÅŸaretliler</button>
  </div>

  <div class="content">

    <div id="studyScreen" class="screen active">
      <div id="questions" class="questions"></div>
    </div>

    <div id="examSetup" class="screen">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0">
        <div>â±ï¸ SÄ±nav SÃ¼resi (saniye):</div>
        <input id="examDuration" type="number" min="30" value="120" style="padding:8px 10px;border-radius:10px;border:none;width:120px">
        <div style="font-size:13px;color:var(--muted)">Minimum 30 sn. (VarsayÄ±lan 120 sn)</div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="small-btn" onclick="startExamFromSetup()">SÄ±navÄ± BaÅŸlat</button>
        <button class="small-btn" onclick="cancelExamSetup()">Ä°ptal</button>
      </div>
    </div>

    <div id="examScreen" class="screen">
      <div class="exam-top">
        <div>
          <div style="font-weight:600" id="examTitle">ğŸ“ Ã‡oktan SeÃ§meli SÄ±nav</div>
          <div class="progress" id="examProgress"></div>
        </div>
        <div style="text-align:right">
          <div class="timer" id="timerDisplay">00:00</div>
          <div style="font-size:13px;opacity:.9">Kalan sÃ¼re</div>
        </div>
      </div>

      <div class="mcq-card">
        <div id="examQuestion" style="font-weight:600"></div>
        <div id="options" class="options"></div>
      </div>

      <div class="nav">
        <button class="big-btn" onclick="prevQuestion()">â—€ Geri</button>
        <button class="big-btn" onclick="nextQuestion()">Ä°leri â–¶</button>
        <button class="big-btn" onclick="finishExam()">SÄ±navÄ± Bitir</button>
      </div>
    </div>

    <div id="resultScreen" class="screen">
      <h2 style="margin-top:6px">ğŸ“ SÄ±nav Sonucu</h2>
      <p id="resultSummary"></p>
      <div id="detailedResults" class="result-list"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="small-btn" onclick="retryExam()">Tekrar Ã‡Ã¶z</button>
        <button class="small-btn" onclick="exitExam()">Ã‡alÄ±ÅŸma Moduna DÃ¶n</button>
      </div>
    </div>

  </div> <div class="statusbar" aria-hidden="false">
    <div class="status-left">
      <div style="font-weight:600">Modlar:</div>
      <div id="modeList">â€”</div>
    </div>
    <div>
      <span class="score-badge" id="scoreBadge">Puan: 0 â€¢ Seri: 0</span>
    </div>
  </div>

</div> <div id="toast" class="toast"><div class="badge">ğŸ…</div><div id="toastText">Rozet!</div></div>

<script>
/* ========== DATA (KISALTILMIÅ CEVAPLAR) ========== */
const data = [
  {
    q: "1. DÃ¼nya hayatÄ±nÄ±n amacÄ± nedir?",
    // Eski: Uzun paragraf...
    a: "Ahiret iÃ§in bir imtihan yeridir. AmaÃ§; Allah'Ä± tanÄ±mak ve O'na kulluk etmektir.",
    options: [
      { key: "A", text: "Sadece dÃ¼nyevi zevkler iÃ§in yaÅŸamak." },
      { key: "B", text: "Ahiret iÃ§in bir hazÄ±rlÄ±k ve imtihan yeridir." },
      { key: "C", text: "Sadece bilim ve teknolojiyi geliÅŸtirmek." },
      { key: "D", text: "Toplum iÃ§inde statÃ¼ kazanmak." }
    ],
    correct: "B"
  },
  {
    q: "2. Ahiret hayatÄ±na iman etmek insana nasÄ±l bir davranÄ±ÅŸ kazandÄ±rÄ±r?",
    // Eski: Uzun paragraf...
    a: "Sorumluluk bilinci kazandÄ±rÄ±r. Hesap verme inancÄ±yla insanÄ± kÃ¶tÃ¼lÃ¼kten uzak tutar.",
    options: [
      { key: "A", text: "Sorumluluk bilinci kazandÄ±rÄ±r." },
      { key: "B", text: "Ä°nsanlarÄ± umursamaz yapar." },
      { key: "C", text: "Sadece ritÃ¼ellerle meÅŸgul eder." },
      { key: "D", text: "Toplumsal kurallarÄ± Ã¶nemsiz kÄ±lar." }
    ],
    correct: "A"
  },
  {
    q: "3. Kur'an'a gÃ¶re Hz. Muhammed (s.a.v.) nasÄ±l bir insandÄ±r?",
    // Eski: Uzun paragraf...
    a: "Hem vahiy alan bir Peygamber, hem de insani Ã¶zellikleri olan bir beÅŸerdir.",
    options: [
      { key: "A", text: "Sadece ilahi bir varlÄ±k, insan deÄŸil." },
      { key: "B", text: "Vahiy alan bir peygamber ve aynÄ± zamanda beÅŸerdir." },
      { key: "C", text: "Efsanevi, gerÃ§ek olmayan bir figÃ¼r." },
      { key: "D", text: "Sadece siyasal bir lider." }
    ],
    correct: "B"
  },
  {
    q: "4. Hz. Muhammed'in (s.a.v.) en Ã¶nemli bir ahlaki Ã¶zelliÄŸini yazÄ±nÄ±z.",
    // Eski: Uzun paragraf...
    a: "El-EmÃ®n (GÃ¼venilir) olmasÄ±dÄ±r. Asla yalan sÃ¶ylemez, emaneti korurdu.",
    options: [
      { key: "A", text: "Zenginlik" },
      { key: "B", text: "SavaÅŸÃ§Ä±lÄ±k" },
      { key: "C", text: "GÃ¼venilir olmasÄ± (El-EmÃ®n)." },
      { key: "D", text: "Sadece akademik bilgisi" }
    ],
    correct: "C"
  },
  {
    q: "5. \"Ãœsve-i hasene\" ne demektir?",
    // Eski: Uzun paragraf...
    a: "\"En gÃ¼zel Ã¶rnek\" demektir. Peygamberimizin bizim iÃ§in en mÃ¼kemmel model olmasÄ±dÄ±r.",
    options: [
      { key: "A", text: "En gÃ¼zel Ã¶rnek." },
      { key: "B", text: "En kutsal kitap." },
      { key: "C", text: "Bir ibadet tÃ¼rÃ¼." },
      { key: "D", text: "Tarihsel bir bÃ¶lge adÄ±." }
    ],
    correct: "A"
  }
];

/* ========== STATE & PERSISTENCE ========== */
let modes = { think:false, game:false, focus:false };
let starOnly = false;
let score = 0, streak = 0;

/* theme persistence */
function loadTheme(){
  const t = localStorage.getItem('dk_theme');
  if(t === 'light') document.body.classList.add('light');
  else document.body.classList.remove('light');
}
function saveTheme(){
  localStorage.setItem('dk_theme', document.body.classList.contains('light') ? 'light' : 'dark');
}

/* load other persisted state */
function loadState(){
  try{
    const ms = JSON.parse(localStorage.getItem('dk_modes'));
    if(ms) modes = ms;
    const s = JSON.parse(localStorage.getItem('dk_score'));
    if(s){ score = s.score||0; streak = s.streak||0; }
    const so = JSON.parse(localStorage.getItem('dk_starOnly'));
    if(typeof so === 'boolean') starOnly = so;
  }catch(e){}
}
function saveState(){
  localStorage.setItem('dk_modes', JSON.stringify(modes));
  localStorage.setItem('dk_score', JSON.stringify({score,streak}));
  localStorage.setItem('dk_starOnly', JSON.stringify(starOnly));
}

/* ========== RENDER STUDY ========== */
const questionsEl = document.getElementById('questions');
const dimOverlay = document.getElementById('dimOverlay');
const toastEl = document.getElementById('toast');
const toastText = document.getElementById('toastText');

function escapeHtml(text){ return text.replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function renderStudy(){
  questionsEl.innerHTML = '';
  data.forEach((item, idx) => {
    const qWrap = document.createElement('div');
    qWrap.className = 'question';
    qWrap.dataset.index = idx;
    qWrap.innerHTML = `
      <h4>${item.q} <span class="star" style="color:gold;display:none">â­</span></h4>
      <div class="answer">${escapeHtml(item.a)}</div>
      <div class="q-actions">
        <button class="small-btn reveal-btn" onclick="toggleAnswer(this)"><span class="reveal-progress"></span><span class="reveal-text">CevabÄ± GÃ¶ster</span></button>
        <button class="small-btn" onclick="toggleStar(this)">â­ Ã–nemli</button>
      </div>
      <div class="self-eval" style="display:none">
        <div style="font-size:13px;opacity:.9">Sen doÄŸru buldun mu?</div>
        <button class="eval-btn" onclick="selfEval(${idx}, true)">Biliyordum</button>
        <button class="eval-btn" onclick="selfEval(${idx}, false)">YanlÄ±ÅŸ</button>
      </div>
    `;
    questionsEl.appendChild(qWrap);
  });

  // restore mode buttons
  document.querySelectorAll('.mode-btn').forEach(b=>{
    const m = b.dataset.mode;
    if(modes[m]) b.classList.add('active'); else b.classList.remove('active');
  });

  filterStars();
  updateModeList();
  updateScoreBadge();
}

/* load saved state and render */
loadTheme();
loadState();
renderStudy();

/* ========== INTERACTIONS ========== */

function toggleTheme(){
  document.body.classList.toggle('light');
  saveTheme();
}
function toggleMode(mode, btnEl){
  modes[mode] = !modes[mode];
  document.querySelectorAll('.mode-btn').forEach(b=>{
    const m = b.dataset.mode;
    if(modes[m]) b.classList.add('active'); else b.classList.remove('active');
  });
  // if turning off focus remove blur/dim
  if(mode === 'focus' && !modes.focus){
    document.querySelectorAll('.question').forEach(q=>q.classList.remove('blur'));
    dimOverlay.style.background = 'transparent';
  }
  updateModeList();
  saveState();
}

/* toggle answer with think/progress and focus/game handling */
function toggleAnswer(btn){
  const question = btn.closest('.question');
  const ans = question.querySelector('.answer');
  const selfEvalDiv = question.querySelector('.self-eval');

  const revealAction = ()=>{
    const isOpen = ans.classList.toggle('open');
    const txt = btn.querySelector('.reveal-text');
    if(isOpen) txt.innerText = 'Gizle'; else txt.innerText = 'CevabÄ± GÃ¶ster';

    // game mode behavior
    if(modes.game && isOpen){
      selfEvalDiv.style.display = 'flex';
      delete ans.dataset.scored; // allow scoring for this open
    } else {
      selfEvalDiv.style.display = 'none';
    }

    // focus behavior
    if(modes.focus){
      document.querySelectorAll('.question').forEach(q=>{
        if(q !== question){
          if(isOpen) q.classList.add('blur'); else q.classList.remove('blur');
        }
      });
      dimOverlay.style.background = isOpen ? 'var(--dim)' : 'transparent';
    }
    saveState();
  };

  // if think mode and not already open => start progress
  if(modes.think && !ans.classList.contains('open')){
    const progressEl = btn.querySelector('.reveal-progress');
    const textEl = btn.querySelector('.reveal-text');
    btn.disabled = true;
    let t = 5000; // ms
    const step = 100; // ms
    progressEl.style.width = '0%';
    textEl.innerText = 'Bekleyin 5s';
    const iv = setInterval(()=>{
      t -= step;
      const pct = Math.max(0, (5000 - t) / 50); // 0-100
      progressEl.style.width = `${Math.min(100, pct)}%`;
      textEl.innerText = `Bekleyin ${Math.ceil(t/1000)}s`;
      if(t <= 0){
        clearInterval(iv);
        progressEl.style.width = '100%';
        btn.disabled = false;
        textEl.innerText = 'CevabÄ± GÃ¶ster';
        // small delay to let progress show 100%
        setTimeout(()=>{ progressEl.style.width = '0%'; revealAction(); }, 150);
      }
    }, step);
  } else {
    revealAction();
  }
}

/* self-eval for game mode */
function selfEval(index, correct){
  const q = document.querySelector(`.question[data-index="${index}"]`);
  if(!q) return;
  const ans = q.querySelector('.answer');

  if(correct){
    if(!ans.dataset.scored){
      score += 10;
      streak += 1;
      ans.dataset.scored = '1';
      updateScoreBadge();
      saveState();
      if([3,5,10].includes(streak)){
        showBadge(`Rozet kazandÄ±n! Seri: ${streak}`);
      } else {
        showToast('Puan eklendi!');
      }
    } else {
      showToast('Bu aÃ§Ä±lÄ±ÅŸ iÃ§in zaten puan aldÄ±n.');
    }
  } else {
    // wrong: flash red and reset streak
    streak = 0;
    updateScoreBadge();
    saveState();
    q.classList.add('wrong');
    setTimeout(()=> q.classList.remove('wrong'), 900);
    showToast('YanlÄ±ÅŸ iÅŸaretlendi â€” seri sÄ±fÄ±rlandÄ±.');
  }
  // hide self-eval after evaluation
  q.querySelector('.self-eval').style.display = 'none';
}

/* star / filter */
function toggleStar(btn){
  const q = btn.closest('.question');
  const star = q.querySelector('.star');
  q.classList.toggle('starred');
  star.style.display = q.classList.contains('starred') ? 'inline' : 'none';
  filterStars();
  saveState();
}
function toggleStarOnly(){ starOnly = !starOnly; filterStars(); saveState(); updateModeList(); }
function filterStars(){
  document.querySelectorAll('.question').forEach(q=>{
    if(starOnly && !q.classList.contains('starred')) q.style.display = 'none';
    else q.style.display = '';
  });
}

/* open/close all */
function openAll(){
  document.querySelectorAll('.answer').forEach(a=>a.classList.add('open'));
  document.querySelectorAll('.reveal-btn .reveal-text').forEach(t=>t.innerText='Gizle');
  if(modes.game) document.querySelectorAll('.self-eval').forEach(d=>d.style.display='flex');
  // keep container visible at top (settings sticky); scroll to top of container
  const container = document.querySelector('.container');
  container.scrollTo({ top: 0, behavior: 'smooth' });
}
function closeAll(){
  document.querySelectorAll('.answer').forEach(a=>a.classList.remove('open'));
  document.querySelectorAll('.reveal-btn .reveal-text').forEach(t=>t.innerText='CevabÄ± GÃ¶ster');
  document.querySelectorAll('.self-eval').forEach(d=>d.style.display='none');
  document.querySelectorAll('.question').forEach(q=>q.classList.remove('blur'));
  dimOverlay.style.background = 'transparent';
}

/* toast helpers */
let toastTimer = null;
function showToast(text, timeout=1600){
  clearTimeout(toastTimer);
  toastText.innerText = text;
  toastEl.classList.add('show');
  toastTimer = setTimeout(()=> toastEl.classList.remove('show'), timeout);
}
function showBadge(text, timeout=2600){
  clearTimeout(toastTimer);
  toastEl.querySelector('.badge').style.display = 'inline-block';
  toastText.innerText = text;
  toastEl.classList.add('show');
  toastTimer = setTimeout(()=> {
    toastEl.classList.remove('show');
    toastEl.querySelector('.badge').style.display = 'none';
  }, timeout);
}

/* update UI mode list & score */
function updateModeList(){
  const parts = [];
  if(modes.think) parts.push('DÃ¼ÅŸÃ¼n(5s)');
  if(modes.game) parts.push('Oyun');
  if(modes.focus) parts.push('Odak');
  if(starOnly) parts.push('Sadeceâ­');
  document.getElementById('modeList').innerText = parts.length ? parts.join(' Â· ') : 'â€”';
  updateScoreBadge();
}
function updateScoreBadge(){
  document.getElementById('scoreBadge').innerText = `Puan: ${score} â€¢ Seri: ${streak}`;
}

/* save initial UI state */
updateModeList();
updateScoreBadge();

/* ========== EXAM MODE (fixed navigation/visibility) ========== */
let examState = {
  active: false,
  duration: 120,
  remaining: 0,
  timerId: null,
  index: 0,
  answers: Array(data.length).fill(null),
  startedAt: null,
  finished: false
};

const studyScreen = document.getElementById('studyScreen');
const examSetup = document.getElementById('examSetup');
const examScreen = document.getElementById('examScreen');
const resultScreen = document.getElementById('resultScreen');

/* showScreen now handles examSetup as a screen too */
function showScreen(id){
  // remove active from all .screen inside content
  document.querySelectorAll('.content .screen').forEach(s=>s.classList.remove('active'));
  if(id === 'studyScreen' || id === ''){
    document.getElementById('studyScreen').classList.add('active');
    // scroll to top so settings remain visible
    document.querySelector('.container').scrollTo({ top: 0, behavior: 'smooth' });
  } else if(id === 'examSetup'){
    document.getElementById('examSetup').classList.add('active');
    // scroll down to show setup area
    document.querySelector('.container').scrollTo({ top: document.querySelector('.container').scrollHeight, behavior:'smooth' });
  } else if(id === 'examScreen'){
    document.getElementById('examScreen').classList.add('active');
    document.querySelector('.container').scrollTo({ top: 0, behavior: 'smooth' });
  } else if(id === 'resultScreen'){
    document.getElementById('resultScreen').classList.add('active');
    document.querySelector('.container').scrollTo({ top: 0, behavior: 'smooth' });
  } else {
    document.getElementById('studyScreen').classList.add('active');
  }
}

/* open / cancel setup use showScreen */
function openExamSetup(){
  showScreen('examSetup');
}
function cancelExamSetup(){
  showScreen('studyScreen');
}

/* start exam */
function startExamFromSetup(){
  const val = parseInt(document.getElementById('examDuration').value, 10);
  examState.duration = isNaN(val) || val < 30 ? 120 : val;
  startExam();
}

function startExam(){
  examState.active = true;
  examState.remaining = examState.duration;
  examState.index = 0;
  examState.answers = Array(data.length).fill(null);
  examState.startedAt = Date.now();
  examState.finished = false;
  showScreen('examScreen');
  renderExam();
  startTimer();
}

/* timer & exam rendering */
function startTimer(){
  stopTimer();
  updateTimerDisplay();
  examState.timerId = setInterval(()=>{
    examState.remaining--;
    if(examState.remaining <= 0){
      stopTimer();
      autoFinishExam();
    }
    updateTimerDisplay();
  },1000);
}
function stopTimer(){
  if(examState.timerId) { clearInterval(examState.timerId); examState.timerId = null; }
}
function updateTimerDisplay(){
  const d = examState.remaining;
  const m = Math.floor(d/60).toString().padStart(2,'0');
  const s = (d%60).toString().padStart(2,'0');
  document.getElementById('timerDisplay').innerText = `${m}:${s}`;
}
function renderExam(){
  const idx = examState.index;
  const item = data[idx];
  document.getElementById('examQuestion').innerText = item.q;
  document.getElementById('examProgress').innerText = `Soru ${idx+1} / ${data.length}`;
  const optsEl = document.getElementById('options');
  optsEl.innerHTML = '';
  item.options.forEach(opt=>{
    const div = document.createElement('div');
    div.className = 'option' + (examState.answers[idx]===opt.key ? ' selected' : '');
    div.dataset.key = opt.key;
    div.innerHTML = `<strong style="margin-right:8px">${opt.key}.</strong> ${escapeHtml(opt.text)}`;
    div.onclick = ()=> {
      selectOption(opt.key);
      document.querySelectorAll('#options .option').forEach(o=>o.classList.remove('selected'));
      div.classList.add('selected');
    };
    optsEl.appendChild(div);
  });
}
function selectOption(key){
  examState.answers[examState.index] = key;
}
function prevQuestion(){ if(examState.index > 0){ examState.index--; renderExam(); } }
function nextQuestion(){ if(examState.index < data.length - 1){ examState.index++; renderExam(); } }
function finishExam(){ if(!examState.finished){ stopTimer(); examState.finished = true; showResults(); } }
function autoFinishExam(){ examState.finished = true; showResults(true); }

/* results */
function showResults(timeOut=false){
  examState.active = false;
  showScreen('resultScreen');
  let correctCount = 0;
  const details = data.map((item, i) => {
    const user = examState.answers[i];
    const ok = user === item.correct;
    if(ok) correctCount++;
    return {
      q: item.q,
      correct: item.correct,
      user,
      ok,
      aText: item.a,
      correctText: item.options.find(o=>o.key===item.correct).text
    };
  });

  const scorePerc = Math.round((correctCount / data.length) * 100);
  const timeUsed = examState.duration - examState.remaining;
  const took = `${Math.floor(timeUsed/60)}m ${timeUsed%60}s`;
  document.getElementById('resultSummary').innerText =
    `${correctCount} / ${data.length} doÄŸru â€” BaÅŸarÄ±: ${scorePerc}%\nSÃ¼re: ${took}` + (timeOut ? " (SÃ¼re doldu)" : "");

  const detEl = document.getElementById('detailedResults');
  detEl.innerHTML = '';
  details.forEach((d,i)=>{
    const div = document.createElement('div');
    div.className = 'result-item';
    div.innerHTML = `
      <strong>${i+1}. ${d.q}</strong>
      <div style="margin-top:6px">${escapeHtml(d.aText)}</div>
      <div style="margin-top:8px">
        <div><strong>DoÄŸru cevap:</strong> ${d.correct} â€” ${escapeHtml(d.correctText)}</div>
        <div><strong>Sizin cevabÄ±nÄ±z:</strong> ${d.user ? d.user + ' â€” ' + escapeHtml( (data[i].options.find(o=>o.key===d.user)||{text:'-' }).text) : 'Cevap verilmedi'}</div>
        <div style="margin-top:6px;color:${d.ok? 'lightgreen':'#ffb3b3'}"><strong>${d.ok? 'DoÄŸru':'YanlÄ±ÅŸ'}</strong></div>
      </div>
    `;
    detEl.appendChild(div);
  });
}

/* retry & exit */
function retryExam(){
  examState = {
    active:false, duration: examState.duration || 120, remaining: 0, timerId:null, index:0, answers: [], startedAt:null, finished:false
  };
  showScreen('examSetup');
}
function exitExam(){
  stopTimer();
  examState.active=false;
  showScreen('studyScreen');
}

/* keyboard nav for exam */
document.addEventListener('keydown', (e)=>{ 
  if(document.getElementById('examScreen').classList.contains('active')){
    if(e.key === 'ArrowRight') nextQuestion();
    if(e.key === 'ArrowLeft') prevQuestion();
  }
});

/* persist state on unload */
window.addEventListener('beforeunload', ()=> {
  saveState();
  saveTheme();
});
</script>

</body>
</html>